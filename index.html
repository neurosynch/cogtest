<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Back Test</title>
    <!-- jsPsych Library (UMD version for full plugins) -->
    <script src="https://unpkg.com/jspsych@7.3.3/dist/jspsych.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .jspsych-display-element {
            font-size: 48px;
            text-align: center;
        }
    </style>
</head>
<body>
    <script>
        // Initialize jsPsych
        var jsPsych = initJsPsych({
            on_finish: function() {
                // Save data as CSV and display it
                jsPsych.data.get().localSave('csv', 'nback_results.csv');
                jsPsych.data.displayData();
            }
        });

        // Define the timeline
        var timeline = [];

        // Instructions
        var instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p><strong>N-Back Test</strong></p>
                <p>You will see a series of letters. Press the <strong>'F'</strong> key if the current letter matches the one presented just before (1-back).</p>
                <p>Press any key to begin.</p>
            `
        };
        timeline.push(instructions);

        // Define N-Back trials
        var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G']; // Pool of letters
        var sequence = [];
        var n_trials = 20;

        // Generate letter sequence
        for (let i = 0; i < n_trials; i++) {
            if (i > 0 && Math.random() < 0.3) { // 30% chance the letter repeats (match)
                sequence.push(sequence[i - 1]);
            } else {
                let new_letter = letters[Math.floor(Math.random() * letters.length)];
                sequence.push(new_letter);
            }
        }

        // Create trials
        for (let i = 0; i < sequence.length; i++) {
            var trial = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p>${sequence[i]}</p>`,
                choices: ['f'],
                trial_duration: 1000, // 1 second per trial
                post_trial_gap: 500, // 0.5-second gap
                data: {
                    trial_number: i,
                    presented_letter: sequence[i],
                    correct_response: (i > 0 && sequence[i] === sequence[i - 1]) ? 'f' : null
                },
                on_finish: function(data) {
                    data.correct = data.response === data.correct_response; // Record correctness
                }
            };
            timeline.push(trial);
        }

        // Thank you screen
        var end_message = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p>Thank you for participating!</p>
                <p>Your results have been saved as a CSV file.</p>
                <p>Press any key to finish.</p>
            `
        };
        timeline.push(end_message);

        // Run the experiment
        jsPsych.run(timeline);
    </script>
</body>
</html>