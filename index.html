<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Back Test</title>
    
    <!-- Include the full version of jsPsych and required plugins -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    
    <!-- Include the jsPsych stylesheet -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .jspsych-display-element {
            font-size: 48px;
            text-align: center;
        }
    </style>
</head>
<body>
    <script>
        // Initialize jsPsych
        const jsPsych = initJsPsych({
            on_finish: function() {
                // Save data as CSV and display it
                jsPsych.data.get().localSave('csv', 'nback_results.csv');
                jsPsych.data.displayData();
            }
        });

        // Define the timeline
        const timeline = [];

        // Instructions
        const instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <p><strong>N-Back Test</strong></p>
                <p>You will see a series of letters. Press the <strong>'F'</strong> key if the current letter matches the one presented just before (1-back).</p>
                <p>Press any key to begin.</p>
            `,
            choices: "ALL_KEYS"
        };
        timeline.push(instructions);

        // Define N-Back trials
        const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G']; // Pool of letters
        const sequence = [];
        const n_trials = 20;

        // Generate letter sequence
        for (let i = 0; i < n_trials; i++) {
            if (i > 0 && Math.random() < 0.3) { // 30% chance the letter repeats (match)
                sequence.push(sequence[i - 1]);
            } else {
                let new_letter;
                do {
                    new_letter = letters[Math.floor(Math.random() * letters.length)];
                } while (i > 0 && new_letter === sequence[i - 1]); // Ensure no accidental matches
                sequence.push(new_letter);
            }
        }

        // Create trials
        for (let i = 0; i < sequence.length; i++) {
            const trial = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<p>${sequence[i]}</p>`,
                choices: ['f', 'j'], // 'f' for match, 'j' for no match
                trial_duration: 2000, // 2 seconds per trial
                post_trial_gap: 500, // 0.5-second gap
                data: {
                    trial_number: i + 1,
                    presented_letter: sequence[i],
                    previous_letter: i > 0 ? sequence[i - 1] : null,
                    is_match: i > 0 && sequence[i] === sequence[i - 1],
                    correct_response: i > 0 && sequence[i] === sequence[i - 1] ? 'f' : 'j'
                },
                on_finish: function(data) {
                    // Record if response was correct
                    data.correct = data.response === data.correct_response;
                    // Record if it was a miss (no response when should have responded)
                    data.miss = data.is_match && data.response === null;
                    // Record if it was a false alarm (responded when shouldn't have)
                    data.false_alarm = !data.is_match && data.response === 'f';
                }
            };
            timeline.push(trial);
        }

        // Add summary calculation
        const summary = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                const data = jsPsych.data.get().filter({trial_number: {$exists: true}});
                const correct_trials = data.filter({correct: true}).count();
                const total_trials = data.count();
                const accuracy = Math.round((correct_trials / total_trials) * 100);
                const misses = data.filter({miss: true}).count();
                const false_alarms = data.filter({false_alarm: true}).count();
                
                return `
                    <p>Your Results:</p>
                    <p>Accuracy: ${accuracy}%</p>
                    <p>Misses: ${misses}</p>
                    <p>False Alarms: ${false_alarms}</p>
                    <p>Press any key to finish.</p>
                `;
            },
            choices: "ALL_KEYS"
        };
        timeline.push(summary);

        // Run the experiment
        jsPsych.run(timeline);
    </script>
</body>
</html>